<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comet-AI ‚Äî Electron Desktop Integration Guide</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@700;800;900&family=DM+Sans:wght@300;400;500;600&display=swap');
:root{--bg:#080b10;--s1:#0e1420;--s2:#141c2e;--s3:#1a2438;--bd:#1e2d4a;--cyan:#00d4ff;--blue:#3d7eff;--purple:#9b6dff;--green:#00e5a0;--orange:#ff8c42;--pink:#ff4fa3;--yellow:#ffd60a;--text:#e8edf5;--muted:#7a8ba8;--dim:#4a5a70;--code:#070a0f;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.75;overflow-x:hidden;}
.hero{position:relative;padding:80px 40px 70px;text-align:center;overflow:hidden;background:radial-gradient(ellipse 120% 80% at 50% 0%,rgba(61,126,255,.08),transparent 60%),var(--bg);border-bottom:1px solid var(--bd);}
.hero::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(30,45,74,.25) 40px),repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(30,45,74,.25) 40px);pointer-events:none;opacity:.4;}
.hbadge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,rgba(0,212,255,.15),rgba(61,126,255,.15));border:1px solid rgba(0,212,255,.3);border-radius:999px;padding:6px 18px;font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:600;color:var(--cyan);letter-spacing:.12em;text-transform:uppercase;margin-bottom:20px;position:relative;}
.hbadge::before{content:'';width:7px;height:7px;background:var(--cyan);border-radius:50%;box-shadow:0 0 8px var(--cyan);animation:pd 2s ease-in-out infinite;}
@keyframes pd{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
h1{font-family:'Syne',sans-serif;font-size:3rem;font-weight:900;letter-spacing:-.03em;position:relative;}
.brand{background:linear-gradient(135deg,var(--cyan),var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.sub{display:block;font-size:1rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);-webkit-text-fill-color:var(--muted);margin-top:10px;}
.hdesc{color:var(--muted);font-size:.98rem;max-width:700px;margin:16px auto 24px;position:relative;}
.htags{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;position:relative;}
.ht{padding:4px 14px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:600;letter-spacing:.05em;border:1px solid;}
.hc{background:rgba(0,212,255,.1);color:var(--cyan);border-color:rgba(0,212,255,.25);}
.hb{background:rgba(61,126,255,.1);color:#7baeff;border-color:rgba(61,126,255,.25);}
.hp{background:rgba(155,109,255,.1);color:#c4a3ff;border-color:rgba(155,109,255,.25);}
.hg{background:rgba(0,229,160,.1);color:var(--green);border-color:rgba(0,229,160,.25);}
.ho{background:rgba(255,140,66,.1);color:var(--orange);border-color:rgba(255,140,66,.25);}
.hk{background:rgba(255,79,163,.1);color:var(--pink);border-color:rgba(255,79,163,.25);}
.ct{max-width:1120px;margin:0 auto;padding:0 32px;}
.toc{background:var(--s1);border:1px solid var(--bd);border-radius:16px;padding:32px 36px;margin:44px 0;position:relative;overflow:hidden;}
.toc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--cyan),var(--blue),var(--purple));}
.toclbl{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--dim);margin-bottom:20px;}
.tocg{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:4px;}
.toc a{color:var(--muted);text-decoration:none;font-size:.87rem;padding:7px 12px;border-radius:8px;transition:all .15s;display:flex;align-items:center;gap:8px;}
.toc a:hover{background:var(--s2);color:var(--cyan);}
.tn{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--dim);min-width:22px;}
section{margin:56px 0;}
.sh{display:flex;align-items:center;gap:16px;margin-bottom:28px;padding-bottom:16px;border-bottom:1px solid var(--bd);}
.si{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.sic{background:rgba(0,212,255,.12);border:1px solid rgba(0,212,255,.2);}
.sib{background:rgba(61,126,255,.12);border:1px solid rgba(61,126,255,.2);}
.sip{background:rgba(155,109,255,.12);border:1px solid rgba(155,109,255,.2);}
.sig{background:rgba(0,229,160,.12);border:1px solid rgba(0,229,160,.2);}
.sio{background:rgba(255,140,66,.12);border:1px solid rgba(255,140,66,.2);}
.sik{background:rgba(255,79,163,.12);border:1px solid rgba(255,79,163,.2);}
.siy{background:rgba(255,214,10,.12);border:1px solid rgba(255,214,10,.2);}
.sir{background:rgba(255,70,70,.12);border:1px solid rgba(255,70,70,.2);}
h2{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;letter-spacing:-.02em;}
h3{font-size:1.1rem;font-weight:600;margin:32px 0 14px;color:var(--text);}
h4{font-family:'JetBrains Mono',monospace;font-size:.73rem;font-weight:700;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin:22px 0 10px;}
p{color:var(--muted);margin-bottom:14px;}
.card{background:var(--s1);border:1px solid var(--bd);border-radius:12px;padding:20px 24px;margin:14px 0;}
.ct2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:14px 0;}
.ct3{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin:14px 0;}
.mc{background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:16px 18px;}
.mid{font-family:'JetBrains Mono',monospace;font-size:.78rem;background:var(--code);color:var(--green);padding:3px 9px;border-radius:5px;display:inline-block;margin:6px 0;word-break:break-all;}
.tag{display:inline-block;padding:2px 9px;border-radius:999px;font-size:.7rem;font-weight:700;margin:2px;font-family:'JetBrains Mono',monospace;}
.tn-new{background:rgba(0,212,255,.15);color:var(--cyan);}
.tn-st{background:rgba(0,229,160,.15);color:var(--green);}
.tn-pr{background:rgba(255,140,66,.15);color:var(--orange);}
.tn-fl{background:rgba(155,109,255,.15);color:#c4a3ff;}
.tn-ft{background:rgba(61,126,255,.15);color:#7baeff;}
.tn-ro{background:rgba(255,79,163,.15);color:var(--pink);}
pre{background:var(--code);border:1px solid var(--bd);border-radius:12px;padding:22px 26px;overflow-x:auto;font-size:.79rem;line-height:1.7;margin:16px 0;position:relative;}
pre::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,var(--blue),transparent);opacity:.5;}
code{font-family:'JetBrains Mono',monospace;}
pre code{color:#cdd6f0;}
.kw{color:#7baeff;}.str{color:#98e4a5;}.cmt{color:#3a4f6a;font-style:italic;}.fn{color:#ff99cc;}.num{color:#ffb86c;}.cls{color:#c4a3ff;}.var{color:#cdd6f0;}.key{color:#00d4ff;}
.flow{background:var(--code);border:1px solid var(--bd);border-radius:12px;padding:24px 28px;margin:18px 0;font-family:'JetBrains Mono',monospace;font-size:.78rem;line-height:2.4;}
.fl{font-size:.65rem;text-transform:uppercase;letter-spacing:.15em;color:var(--dim);margin-bottom:12px;}
.fn-n{display:inline-block;padding:4px 13px;border-radius:7px;font-weight:700;font-size:.74rem;}
.nc{background:rgba(0,212,255,.15);color:var(--cyan);border:1px solid rgba(0,212,255,.3);}
.nb{background:rgba(61,126,255,.15);color:#7baeff;border:1px solid rgba(61,126,255,.3);}
.np{background:rgba(155,109,255,.15);color:#c4a3ff;border:1px solid rgba(155,109,255,.3);}
.ng{background:rgba(0,229,160,.15);color:var(--green);border:1px solid rgba(0,229,160,.3);}
.nr{background:rgba(255,70,70,.15);color:#ff8080;border:1px solid rgba(255,70,70,.3);}
.no{background:rgba(255,140,66,.15);color:var(--orange);border:1px solid rgba(255,140,66,.3);}
.nk{background:rgba(255,79,163,.15);color:var(--pink);border:1px solid rgba(255,79,163,.3);}
.ny{background:rgba(255,214,10,.15);color:var(--yellow);border:1px solid rgba(255,214,10,.3);}
.arr{color:var(--dim);padding:0 4px;}
.al{border-radius:10px;padding:14px 18px;margin:18px 0;font-size:.88rem;border-left:3px solid;display:flex;gap:10px;align-items:flex-start;}
.al-i{flex-shrink:0;font-size:1rem;margin-top:1px;}.al-b{flex:1;}
.aw{background:rgba(255,140,66,.08);border-color:var(--orange);color:#fdc080;}
.ai{background:rgba(61,126,255,.08);border-color:var(--blue);color:#9dbfff;}
.at{background:rgba(0,229,160,.08);border-color:var(--green);color:#80f0c8;}
.ad{background:rgba(255,70,70,.08);border-color:#ff4646;color:#ffa0a0;}
table{width:100%;border-collapse:collapse;font-size:.86rem;margin:16px 0;}
th{background:var(--s2);color:var(--muted);text-align:left;padding:10px 16px;font-weight:600;border-bottom:1px solid var(--bd);font-family:'JetBrains Mono',monospace;font-size:.7rem;letter-spacing:.06em;text-transform:uppercase;}
td{padding:10px 16px;border-bottom:1px solid rgba(30,45,74,.5);color:var(--muted);}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(0,212,255,.03);}
.mo{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--green);}
.mcpg{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin:18px 0;}
.mcc{background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:16px 18px;}
.mct{font-weight:600;font-size:.9rem;color:var(--text);display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.mcs{font-size:.68rem;padding:2px 8px;border-radius:999px;font-weight:700;margin-left:auto;font-family:'JetBrains Mono',monospace;}
.mco{background:rgba(0,229,160,.15);color:var(--green);}
.mcm{background:rgba(255,140,66,.15);color:var(--orange);}
.mcu{background:rgba(155,109,255,.15);color:#c4a3ff;}
.mcn{background:rgba(0,212,255,.15);color:var(--cyan);}
.new-f{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(90deg,rgba(0,212,255,.2),rgba(155,109,255,.2));border:1px solid rgba(0,212,255,.4);border-radius:999px;padding:2px 12px;font-family:'JetBrains Mono',monospace;font-size:.63rem;font-weight:700;color:var(--cyan);letter-spacing:.08em;text-transform:uppercase;vertical-align:middle;margin-left:8px;}
.pr{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid rgba(30,45,74,.4);font-size:.86rem;}
.pr:last-child{border-bottom:none;}
.pi{font-size:1.1rem;width:26px;flex-shrink:0;}
.pn{font-weight:600;min-width:180px;color:var(--text);font-size:.87rem;}
.pb{font-size:.7rem;padding:2px 9px;border-radius:999px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.pb-r{background:rgba(255,70,70,.2);color:#ff9090;}
.pb-o{background:rgba(255,140,66,.2);color:#ffb86c;}
.pb-g{background:rgba(255,214,10,.2);color:var(--yellow);}
.pd{color:var(--muted);font-size:.82rem;flex:1;}
.sc{background:linear-gradient(135deg,rgba(0,229,160,.06),rgba(61,126,255,.06));border:1px solid rgba(0,229,160,.2);border-radius:14px;padding:22px 26px;margin:14px 0;}
hr{border:none;border-top:1px solid var(--bd);margin:48px 0;}
footer{text-align:center;color:var(--dim);font-size:.82rem;padding:36px;border-top:1px solid var(--bd);margin-top:60px;font-family:'JetBrains Mono',monospace;}
@media(max-width:700px){h1{font-size:2rem;}.ct2,.ct3{grid-template-columns:1fr;}pre{font-size:.72rem;}.ct{padding:0 16px;}}
</style></head>
<body>
<!-- HERO -->
<div class="hero">
  <div class="hbadge">Electron ¬∑ CEF ¬∑ RobotJS ¬∑ Tesseract ¬∑ MCP ¬∑ Flutter Bridge</div>
  <h1><span class="brand">Comet-AI</span><span class="sub">Electron Desktop Integration Guide</span></h1>
  <p class="hdesc">Complete reference for building the Comet-AI agentic desktop browser with Electron + CEF sandbox, cross-app RobotJS automation, Tesseract OCR click targeting, Flutter companion control, enhanced MCP v2, screen vision AI, and security-gated desktop actions.</p>
  <div class="htags">
    <span class="ht hc">Electron 32+</span>
    <span class="ht hb">CEF Sandbox</span>
    <span class="ht hp">RobotJS</span>
    <span class="ht hg">Tesseract OCR</span>
    <span class="ht ho">Flutter Bridge</span>
    <span class="ht hk">MCP v2</span>
    <span class="ht hc">Feb 2026</span>
  </div>
</div>
<div class="ct">
<!-- TOC -->
<nav class="toc">
<div class="toclbl">// Contents</div>
<div class="tocg">
  <a href="#sec1"><span class="tn">01</span>Security Architecture</a>
  <a href="#sec2"><span class="tn">02</span>CEF Sandboxed Browser</a>
  <a href="#sec3"><span class="tn">03</span>Architecture Overview</a>
  <a href="#sec4"><span class="tn">04</span>Project Setup</a>
  <a href="#sec5"><span class="tn">05</span>AI Provider Service</a>
  <a href="#sec6"><span class="tn">06</span>RobotJS Cross-App Control</a>
  <a href="#sec7"><span class="tn">07</span>Tesseract OCR Click Engine</a>
  <a href="#sec8"><span class="tn">08</span>Secure Action Gating</a>
  <a href="#sec9"><span class="tn">09</span>Flutter ‚Üî Electron Bridge</a>
  <a href="#sec10"><span class="tn">10</span>MCP Enhanced v2</a>
  <a href="#sec11"><span class="tn">11</span>Web Search Integration</a>
  <a href="#sec12"><span class="tn">12</span>RAG + LanceDB</a>
  <a href="#sec13"><span class="tn">13</span>Screen Vision AI</a>
  <a href="#sec14"><span class="tn">14</span>Voice Control</a>
  <a href="#sec15"><span class="tn">15</span>Workflow Recorder</a>
  <a href="#sec16"><span class="tn">16</span>Tips &amp; Best Practices</a>
</div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 5 ‚Äî AI PROVIDER INTEGRATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="ai-providers">
  <div class="section-header">
    <div class="s-icon si-purple">ü§ñ</div>
    <h2>5. AI Provider Integration</h2>
  </div>
  <p>Comet-AI Desktop supports multiple LLM providers via a unified <code>AiProviderService</code> interface. All calls are validated by the security layer before dispatch and support streaming responses via IPC back to the renderer UI.</p>

  <h3>Supported Models ‚Äî Feb 2026</h3>
  <div class="grid-3">
    <div class="model-card">
      <div class="card-title" style="font-size:0.85rem;">Google Gemini</div>
      <div class="model-id">gemini-2.5-pro-preview</div>
      <div class="model-desc">Best for complex reasoning, long context, multimodal. Top choice for agentic workflows.</div>
      <div style="margin-top:8px"><span class="tag tag-flagship">Flagship</span><span class="tag tag-new">2M ctx</span></div>
    </div>
    <div class="model-card">
      <div class="card-title" style="font-size:0.85rem;">Google Gemini Flash</div>
      <div class="model-id">gemini-2.5-flash-preview</div>
      <div class="model-desc">Speed-optimized. Ideal for streaming chat, OCR resolution, quick Q&A tasks.</div>
      <div style="margin-top:8px"><span class="tag tag-fast">Fast</span><span class="tag tag-stable">Stable</span></div>
    </div>
    <div class="model-card">
      <div class="card-title" style="font-size:0.85rem;">Groq Llama 3.3</div>
      <div class="model-id">llama-3.3-70b-versatile</div>
      <div class="model-desc">Blazing fast via Groq inference. Best for robot action planning ‚Äî sub-200ms response.</div>
      <div style="margin-top:8px"><span class="tag tag-robot">Robot</span><span class="tag tag-fast">Ultra Fast</span></div>
    </div>
    <div class="model-card">
      <div class="card-title" style="font-size:0.85rem;">Groq Llama 3.1 8B</div>
      <div class="model-id">llama-3.1-8b-instant</div>
      <div class="model-desc">Tiny, instant. Best model for OCR target resolution ‚Äî just needs to pick from options.</div>
      <div style="margin-top:8px"><span class="tag tag-fast">Instant</span><span class="tag tag-robot">OCR</span></div>
    </div>
    <div class="model-card">
      <div class="card-title" style="font-size:0.85rem;">OpenAI GPT-5</div>
      <div class="model-id">gpt-5.2</div>
      <div class="model-desc">Top reasoning. Best for MCP orchestration, complex multi-tool workflows, and code generation.</div>
      <div style="margin-top:8px"><span class="tag tag-flagship">Flagship</span><span class="tag tag-new">Latest</span></div>
    </div>
    <div class="model-card">
      <div class="card-title" style="font-size:0.85rem;">Claude Sonnet 4.6</div>
      <div class="model-id">claude-sonnet-4-6</div>
      <div class="model-desc">Excellent for screen vision analysis, writing, safe summarization. Strong safety filters.</div>
      <div style="margin-top:8px"><span class="tag tag-secure">Vision</span><span class="tag tag-stable">Reliable</span></div>
    </div>
  </div>

  <h3>ai-engine.ts ‚Äî Unified Provider Service</h3>
  <pre><code><span class="cmt">// ai-engine.ts ‚Äî Unified LLM provider interface
// Supports Gemini, Groq, OpenAI, Anthropic with streaming</span>

<span class="kw">import</span> { <span class="cls">GoogleGenerativeAI</span> } <span class="kw">from</span> <span class="str">'@google/generative-ai'</span>;
<span class="kw">import</span> <span class="cls">Groq</span> <span class="kw">from</span> <span class="str">'groq-sdk'</span>;
<span class="kw">import</span> <span class="cls">OpenAI</span> <span class="kw">from</span> <span class="str">'openai'</span>;
<span class="kw">import</span> <span class="cls">Anthropic</span> <span class="kw">from</span> <span class="str">'@anthropic-ai/sdk'</span>;
<span class="kw">import</span> { safeStorage } <span class="kw">from</span> <span class="str">'electron'</span>;

<span class="kw">type</span> <span class="cls">Provider</span> = <span class="str">'gemini'</span> | <span class="str">'groq'</span> | <span class="str">'openai'</span> | <span class="str">'anthropic'</span>;

<span class="kw">interface</span> <span class="cls">ChatOptions</span> {
  message: <span class="kw">string</span>;
  model: <span class="kw">string</span>;
  systemPrompt?: <span class="kw">string</span>;
  history?: { role: <span class="str">'user'</span> | <span class="str">'assistant'</span>; content: <span class="kw">string</span> }[];
  onChunk?: (chunk: <span class="kw">string</span>) =&gt; <span class="kw">void</span>;
}

<span class="kw">export class</span> <span class="cls">CometAiEngine</span> {
  <span class="kw">private</span> gemini: <span class="cls">GoogleGenerativeAI</span>;
  <span class="kw">private</span> groq: <span class="cls">Groq</span>;
  <span class="kw">private</span> openai: <span class="cls">OpenAI</span>;
  <span class="kw">private</span> anthropic: <span class="cls">Anthropic</span>;

  <span class="fn">constructor</span>() {
    <span class="cmt">// Load API keys from OS secure keychain</span>
    <span class="kw">this</span>.gemini = <span class="kw">new</span> <span class="cls">GoogleGenerativeAI</span>(<span class="kw">this</span>.<span class="fn">getKey</span>(<span class="str">'GEMINI_API_KEY'</span>));
    <span class="kw">this</span>.groq = <span class="kw">new</span> <span class="cls">Groq</span>({ apiKey: <span class="kw">this</span>.<span class="fn">getKey</span>(<span class="str">'GROQ_API_KEY'</span>) });
    <span class="kw">this</span>.openai = <span class="kw">new</span> <span class="cls">OpenAI</span>({ apiKey: <span class="kw">this</span>.<span class="fn">getKey</span>(<span class="str">'OPENAI_API_KEY'</span>) });
    <span class="kw">this</span>.anthropic = <span class="kw">new</span> <span class="cls">Anthropic</span>({ apiKey: <span class="kw">this</span>.<span class="fn">getKey</span>(<span class="str">'ANTHROPIC_API_KEY'</span>) });
  }

  <span class="kw">private</span> <span class="fn">getKey</span>(name: <span class="kw">string</span>): <span class="kw">string</span> {
    <span class="kw">try</span> {
      <span class="kw">const</span> enc = safeStorage.<span class="fn">decryptString</span>(<span class="cls">Buffer</span>.<span class="fn">from</span>(process.env[name] ?? <span class="str">''</span>, <span class="str">'base64'</span>));
      <span class="kw">return</span> enc || process.env[name] || <span class="str">''</span>;
    } <span class="kw">catch</span> { <span class="kw">return</span> process.env[name] || <span class="str">''</span>; }
  }

  <span class="kw">private</span> <span class="fn">inferProvider</span>(model: <span class="kw">string</span>): <span class="cls">Provider</span> {
    <span class="kw">if</span> (model.<span class="fn">startsWith</span>(<span class="str">'gemini'</span>)) <span class="kw">return</span> <span class="str">'gemini'</span>;
    <span class="kw">if</span> (model.<span class="fn">startsWith</span>(<span class="str">'llama'</span>) || model.<span class="fn">startsWith</span>(<span class="str">'mixtral'</span>)) <span class="kw">return</span> <span class="str">'groq'</span>;
    <span class="kw">if</span> (model.<span class="fn">startsWith</span>(<span class="str">'gpt'</span>) || model.<span class="fn">startsWith</span>(<span class="str">'o'</span>)) <span class="kw">return</span> <span class="str">'openai'</span>;
    <span class="kw">if</span> (model.<span class="fn">startsWith</span>(<span class="str">'claude'</span>)) <span class="kw">return</span> <span class="str">'anthropic'</span>;
    <span class="kw">return</span> <span class="str">'groq'</span>; <span class="cmt">// default: fastest</span>
  }

  <span class="kw">async</span> <span class="fn">chat</span>(opts: <span class="cls">ChatOptions</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> provider = <span class="kw">this</span>.<span class="fn">inferProvider</span>(opts.model);
    <span class="kw">switch</span> (provider) {
      <span class="kw">case</span> <span class="str">'gemini'</span>: <span class="kw">return this</span>.<span class="fn">chatGemini</span>(opts);
      <span class="kw">case</span> <span class="str">'groq'</span>: <span class="kw">return this</span>.<span class="fn">chatGroq</span>(opts);
      <span class="kw">case</span> <span class="str">'openai'</span>: <span class="kw">return this</span>.<span class="fn">chatOpenAI</span>(opts);
      <span class="kw">case</span> <span class="str">'anthropic'</span>: <span class="kw">return this</span>.<span class="fn">chatAnthropic</span>(opts);
    }
  }

  <span class="kw">private async</span> <span class="fn">chatGroq</span>(opts: <span class="cls">ChatOptions</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> messages: <span class="kw">any</span>[] = [];
    <span class="kw">if</span> (opts.systemPrompt) messages.<span class="fn">push</span>({ role: <span class="str">'system'</span>, content: opts.systemPrompt });
    <span class="kw">for</span> (<span class="kw">const</span> h <span class="kw">of</span> opts.history ?? []) messages.<span class="fn">push</span>(h);
    messages.<span class="fn">push</span>({ role: <span class="str">'user'</span>, content: opts.message });

    <span class="kw">if</span> (opts.onChunk) {
      <span class="kw">const</span> stream = <span class="kw">await this</span>.groq.chat.completions.<span class="fn">create</span>({
        model: opts.model, messages, stream: <span class="kw">true</span>, max_tokens: <span class="num">8192</span>
      });
      <span class="kw">let</span> full = <span class="str">''</span>;
      <span class="kw">for await</span> (<span class="kw">const</span> chunk <span class="kw">of</span> stream) {
        <span class="kw">const</span> delta = chunk.choices[<span class="num">0</span>]?.delta?.content ?? <span class="str">''</span>;
        full += delta;
        opts.onChunk(delta);
      }
      <span class="kw">return</span> full;
    }
    <span class="kw">const</span> res = <span class="kw">await this</span>.groq.chat.completions.<span class="fn">create</span>({
      model: opts.model, messages, max_tokens: <span class="num">8192</span>
    });
    <span class="kw">return</span> res.choices[<span class="num">0</span>].message.content ?? <span class="str">''</span>;
  }

  <span class="kw">private async</span> <span class="fn">chatGemini</span>(opts: <span class="cls">ChatOptions</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> model = <span class="kw">this</span>.gemini.<span class="fn">getGenerativeModel</span>({
      model: opts.model,
      systemInstruction: opts.systemPrompt
    });
    <span class="kw">const</span> chat = model.<span class="fn">startChat</span>({
      history: (opts.history ?? []).<span class="fn">map</span>(h =&gt; ({
        role: h.role === <span class="str">'assistant'</span> ? <span class="str">'model'</span> : <span class="str">'user'</span>,
        parts: [{ text: h.content }]
      }))
    });
    <span class="kw">if</span> (opts.onChunk) {
      <span class="kw">const</span> stream = <span class="kw">await</span> chat.<span class="fn">sendMessageStream</span>(opts.message);
      <span class="kw">let</span> full = <span class="str">''</span>;
      <span class="kw">for await</span> (<span class="kw">const</span> chunk <span class="kw">of</span> stream.stream) {
        <span class="kw">const</span> text = chunk.<span class="fn">text</span>();
        full += text; opts.onChunk(text);
      }
      <span class="kw">return</span> full;
    }
    <span class="kw">return</span> (await chat.<span class="fn">sendMessage</span>(opts.message)).response.<span class="fn">text</span>();
  }

  <span class="kw">private async</span> <span class="fn">chatAnthropic</span>(opts: <span class="cls">ChatOptions</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> res = <span class="kw">await this</span>.anthropic.messages.<span class="fn">create</span>({
      model: opts.model,
      max_tokens: <span class="num">8192</span>,
      system: opts.systemPrompt,
      messages: [
        ...(opts.history ?? []),
        { role: <span class="str">'user'</span>, content: opts.message }
      ]
    });
    <span class="kw">return</span> (res.content[<span class="num">0</span>] <span class="kw">as any</span>).text;
  }
}</code></pre>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 6 ‚Äî ROBOTJS CROSS-APP CONTROL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="robotjs">
  <div class="section-header">
    <div class="s-icon si-pink">ü§ñ</div>
    <h2>6. RobotJS Cross-App Control <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>RobotJS gives Comet-AI OS-level mouse and keyboard control ‚Äî it can click buttons in any app, type text, trigger shortcuts, and scroll, all from the main Electron process. This is the most powerful and dangerous capability in the entire stack: one misfire can click "Confirm Delete" in the wrong window.</p>

  <div class="robot-pipeline">
    <div class="flow-label">// RobotJS Action Pipeline</div>
    <div style="line-height:2.6">
      <span class="fn-node nn-cyan">Natural Language Command</span><span class="arr"> ‚Üí </span>
      <span class="fn-node nn-red">Security Classify</span><span class="arr"> ‚Üí </span>
      <span class="fn-node nn-orange">Permission Gate</span>
      <br>
      <span style="color:var(--text-dim);padding-left:20px">‚Üì allowed</span><br>
      <span style="padding-left:20px">
        <span class="fn-node nn-blue">LLM Action Planner</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-purple">Zod Schema Validate</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-yellow">User Confirm Dialog</span>
      </span>
      <br>
      <span style="color:var(--text-dim);padding-left:20px">‚Üì confirmed</span><br>
      <span style="padding-left:20px">
        <span class="fn-node nn-green">Coord Bounds Check</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-pink">RobotJS Execute</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-yellow">Audit Log</span>
      </span>
    </div>
  </div>

  <h3>robot-service.ts ‚Äî Gated RobotJS Executor</h3>
  <pre><code><span class="cmt">// robot-service.ts ‚Äî Comet-AI Desktop
// OS-level cross-app automation via RobotJS
// ALL actions gated by PermissionStore + user confirmation</span>

<span class="kw">import</span> robot <span class="kw">from</span> <span class="str">'@jitsi/robotjs'</span>;
<span class="kw">import</span> { screen } <span class="kw">from</span> <span class="str">'electron'</span>;
<span class="kw">import</span> { z } <span class="kw">from</span> <span class="str">'zod'</span>;
<span class="kw">import</span> { <span class="cls">PermissionStore</span> } <span class="kw">from</span> <span class="str">'./permission-store'</span>;
<span class="kw">import</span> { <span class="cls">CometSecurityService</span> } <span class="kw">from</span> <span class="str">'./security-service'</span>;

<span class="cmt">// Zod schemas for all action types</span>
<span class="kw">const</span> <span class="cls">ClickAction</span> = z.<span class="fn">object</span>({
  type: z.<span class="fn">literal</span>(<span class="str">'click'</span>),
  x: z.<span class="fn">number</span>().<span class="fn">int</span>().<span class="fn">positive</span>(),
  y: z.<span class="fn">number</span>().<span class="fn">int</span>().<span class="fn">positive</span>(),
  button: z.<span class="fn">enum</span>([<span class="str">'left'</span>, <span class="str">'right'</span>, <span class="str">'middle'</span>]).<span class="fn">default</span>(<span class="str">'left'</span>),
  double: z.<span class="fn">boolean</span>().<span class="fn">optional</span>(),
  reason: z.<span class="fn">string</span>(), <span class="cmt">// shown to user in confirm dialog</span>
});

<span class="kw">const</span> <span class="cls">TypeAction</span> = z.<span class="fn">object</span>({
  type: z.<span class="fn">literal</span>(<span class="str">'type'</span>),
  text: z.<span class="fn">string</span>().<span class="fn">max</span>(<span class="num">2000</span>),
  reason: z.<span class="fn">string</span>(),
});

<span class="kw">const</span> <span class="cls">KeyAction</span> = z.<span class="fn">object</span>({
  type: z.<span class="fn">literal</span>(<span class="str">'key'</span>),
  key: z.<span class="fn">string</span>(),
  modifiers: z.<span class="fn">array</span>(z.<span class="fn">enum</span>([<span class="str">'command'</span>, <span class="str">'control'</span>, <span class="str">'alt'</span>, <span class="str">'shift'</span>])).<span class="fn">optional</span>(),
  reason: z.<span class="fn">string</span>(),
});

<span class="kw">const</span> <span class="cls">ScrollAction</span> = z.<span class="fn">object</span>({
  type: z.<span class="fn">literal</span>(<span class="str">'scroll'</span>),
  x: z.<span class="fn">number</span>(), y: z.<span class="fn">number</span>(),
  direction: z.<span class="fn">enum</span>([<span class="str">'up'</span>, <span class="str">'down'</span>, <span class="str">'left'</span>, <span class="str">'right'</span>]),
  amount: z.<span class="fn">number</span>().<span class="fn">min</span>(<span class="num">1</span>).<span class="fn">max</span>(<span class="num">20</span>).<span class="fn">default</span>(<span class="num">3</span>),
  reason: z.<span class="fn">string</span>(),
});

<span class="kw">export const</span> <span class="cls">RobotAction</span> = z.<span class="fn">discriminatedUnion</span>(<span class="str">'type'</span>, [
  <span class="cls">ClickAction</span>, <span class="cls">TypeAction</span>, <span class="cls">KeyAction</span>, <span class="cls">ScrollAction</span>
]);
<span class="kw">export type</span> <span class="cls">RobotAction</span> = z.<span class="fn">infer</span>&lt;<span class="kw">typeof</span> <span class="cls">RobotAction</span>&gt;;

<span class="kw">export class</span> <span class="cls">RobotService</span> {
  <span class="kw">private</span> lastAction = <span class="num">0</span>;
  <span class="kw">private readonly</span> MIN_DELAY_MS = <span class="num">300</span>; <span class="cmt">// rate-limit between actions</span>

  <span class="kw">async</span> <span class="fn">execute</span>(raw: <span class="kw">unknown</span>, perms: <span class="cls">PermissionStore</span>): <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt; {
    <span class="cmt">// 1. Schema validate</span>
    <span class="kw">const</span> action = <span class="cls">RobotAction</span>.<span class="fn">parse</span>(raw);

    <span class="cmt">// 2. Permission gate</span>
    <span class="kw">if</span> (!perms.<span class="fn">isGranted</span>(<span class="str">'robot'</span>)) {
      <span class="kw">throw new</span> <span class="cls">Error</span>(<span class="str">'Robot permission not granted. User must approve in Settings.'</span>);
    }

    <span class="cmt">// 3. Coordinate bounds check</span>
    <span class="kw">if</span> (action.type === <span class="str">'click'</span> || action.type === <span class="str">'scroll'</span>) {
      <span class="kw">this</span>.<span class="fn">validateCoords</span>(action.x, action.y);
    }

    <span class="cmt">// 4. Rate limiting</span>
    <span class="kw">const</span> now = <span class="cls">Date</span>.<span class="fn">now</span>();
    <span class="kw">if</span> (now - <span class="kw">this</span>.lastAction &lt; <span class="kw">this</span>.MIN_DELAY_MS) {
      <span class="kw">await</span> <span class="kw">new</span> <span class="cls">Promise</span>(r =&gt; <span class="fn">setTimeout</span>(r, <span class="kw">this</span>.MIN_DELAY_MS));
    }

    <span class="cmt">// 5. Execute action</span>
    <span class="kw">switch</span> (action.type) {
      <span class="kw">case</span> <span class="str">'click'</span>:
        robot.<span class="fn">moveMouse</span>(action.x, action.y);
        <span class="kw">await</span> <span class="fn">sleep</span>(<span class="num">80</span>);
        robot.<span class="fn">mouseClick</span>(action.button, action.double ?? <span class="kw">false</span>);
        <span class="kw">break</span>;
      <span class="kw">case</span> <span class="str">'type'</span>:
        robot.<span class="fn">typeString</span>(action.text);
        <span class="kw">break</span>;
      <span class="kw">case</span> <span class="str">'key'</span>:
        robot.<span class="fn">keyTap</span>(action.key, action.modifiers ?? []);
        <span class="kw">break</span>;
      <span class="kw">case</span> <span class="str">'scroll'</span>:
        robot.<span class="fn">moveMouse</span>(action.x, action.y);
        robot.<span class="fn">scrollMouse</span>(action.amount, action.direction);
        <span class="kw">break</span>;
    }

    <span class="kw">this</span>.lastAction = <span class="cls">Date</span>.<span class="fn">now</span>();

    <span class="cmt">// 6. Audit log</span>
    <span class="cls">CometSecurityService</span>.<span class="fn">createAuditEntry</span>(<span class="str">'robot.execute'</span>, {
      actionType: action.type,
      reason: action.reason,
    });
  }

  <span class="kw">private</span> <span class="fn">validateCoords</span>(x: <span class="kw">number</span>, y: <span class="kw">number</span>): <span class="kw">void</span> {
    <span class="kw">const</span> displays = screen.<span class="fn">getAllDisplays</span>();
    <span class="kw">const</span> valid = displays.<span class="fn">some</span>(d =&gt;
      x &gt;= d.bounds.x && x &lt; d.bounds.x + d.bounds.width &&
      y &gt;= d.bounds.y && y &lt; d.bounds.y + d.bounds.height
    );
    <span class="kw">if</span> (!valid) <span class="kw">throw new</span> <span class="cls">Error</span>(<span class="str">`Coordinates (${x}, ${y}) are outside all display bounds`</span>);
  }
}

<span class="kw">const</span> <span class="fn">sleep</span> = (ms: <span class="kw">number</span>) =&gt; <span class="kw">new</span> <span class="cls">Promise</span>(r =&gt; <span class="fn">setTimeout</span>(r, ms));</code></pre>

  <div class="alert alert-danger">
    <div class="alert-icon">üö®</div>
    <div class="alert-body">Always show users a clear confirmation dialog before executing RobotJS click/type/key actions. Show the exact text: <em>"Click 'Submit' at (923, 442) in Google Chrome"</em>. Never auto-execute write-or-submit actions. Include a global kill-switch hotkey (Cmd/Ctrl+Shift+Esc) that aborts any active action sequence.</div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 7 ‚Äî TESSERACT OCR CLICK ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="tesseract">
  <div class="section-header">
    <div class="s-icon si-yellow">üëÅÔ∏è</div>
    <h2>7. Tesseract OCR Click Engine <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>The Tesseract OCR engine allows Comet-AI to "see" the screen and click any button or text element in any app ‚Äî even native desktop apps with no DOM. It captures the screen, extracts text regions with bounding boxes, resolves the target with LLM assistance, and executes the click via RobotJS.</p>

  <div class="ocr-panel">
    <div class="flow-label">// OCR Click Pipeline</div>
    <div style="line-height:2.6">
      <span class="fn-node nn-yellow">User: "Click the Pay button"</span><span class="arr"> ‚Üí </span>
      <span class="fn-node nn-blue">desktopCapturer</span><span class="arr"> ‚Üí </span>
      <span class="fn-node nn-orange">sharp preprocess</span>
      <br>
      <span style="color:var(--text-dim);padding-left:20px">‚Üì</span><br>
      <span style="padding-left:20px">
        <span class="fn-node nn-cyan">Tesseract.js OCR</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-purple">Word Bounding Boxes</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-green">LLM Target Resolver</span>
      </span>
      <br>
      <span style="color:var(--text-dim);padding-left:20px">‚Üì target coords</span><br>
      <span style="padding-left:20px">
        <span class="fn-node nn-pink">RobotJS click(x,y)</span><span class="arr"> ‚Üí </span>
        <span class="fn-node nn-yellow">Audit Log</span>
      </span>
    </div>
  </div>

  <h3>tesseract-service.ts ‚Äî Screen OCR + Click</h3>
  <pre><code><span class="cmt">// tesseract-service.ts ‚Äî Comet-AI Desktop
// Screen capture ‚Üí Tesseract WASM OCR ‚Üí click target resolution</span>

<span class="kw">import</span> { <span class="fn">createWorker</span> } <span class="kw">from</span> <span class="str">'tesseract.js'</span>;
<span class="kw">import</span> { desktopCapturer, screen } <span class="kw">from</span> <span class="str">'electron'</span>;
<span class="kw">import</span> sharp <span class="kw">from</span> <span class="str">'sharp'</span>;
<span class="kw">import</span> { <span class="cls">CometAiEngine</span> } <span class="kw">from</span> <span class="str">'./ai-engine'</span>;
<span class="kw">import</span> { <span class="cls">RobotService</span>, <span class="cls">RobotAction</span> } <span class="kw">from</span> <span class="str">'./robot-service'</span>;

<span class="kw">export interface</span> <span class="cls">OcrWord</span> {
  text: <span class="kw">string</span>;
  confidence: <span class="kw">number</span>;
  bbox: { x0: <span class="kw">number</span>; y0: <span class="kw">number</span>; x1: <span class="kw">number</span>; y1: <span class="kw">number</span> };
  centerX: <span class="kw">number</span>;
  centerY: <span class="kw">number</span>;
}

<span class="kw">export class</span> <span class="cls">TesseractOcrService</span> {
  <span class="kw">private</span> worker: <span class="kw">any</span> | <span class="kw">null</span> = <span class="kw">null</span>;
  <span class="kw">private</span> initialized = <span class="kw">false</span>;

  <span class="kw">async</span> <span class="fn">init</span>(): <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt; {
    <span class="kw">if</span> (<span class="kw">this</span>.initialized) <span class="kw">return</span>;
    <span class="kw">this</span>.worker = <span class="kw">await</span> <span class="fn">createWorker</span>(<span class="str">'eng'</span>, <span class="num">1</span>, {
      corePath: <span class="str">'./node_modules/tesseract.js-core'</span>,
      langPath: <span class="str">'./tessdata'</span>,
      cacheMethod: <span class="str">'write'</span>,
    });
    <span class="kw">this</span>.initialized = <span class="kw">true</span>;
  }

  <span class="cmt">/** Capture full screen and return OCR word list with bounding boxes */</span>
  <span class="kw">async</span> <span class="fn">captureAndOcr</span>(displayId?: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="cls">OcrWord</span>[]&gt; {
    <span class="kw">await this</span>.<span class="fn">init</span>();

    <span class="cmt">// 1. Capture screen</span>
    <span class="kw">const</span> sources = <span class="kw">await</span> desktopCapturer.<span class="fn">getSources</span>({
      types: [<span class="str">'screen'</span>],
      thumbnailSize: { width: <span class="num">2560</span>, height: <span class="num">1440</span> }
    });
    <span class="kw">const</span> source = displayId
      ? sources.<span class="fn">find</span>(s =&gt; s.display_id === displayId) ?? sources[<span class="num">0</span>]
      : sources[<span class="num">0</span>];

    <span class="kw">const</span> png = source.thumbnail.<span class="fn">toPNG</span>();

    <span class="cmt">// 2. Preprocess with sharp: grayscale + normalize + sharpen + upscale</span>
    <span class="kw">const</span> processed = <span class="kw">await</span> <span class="fn">sharp</span>(png)
      .<span class="fn">grayscale</span>()
      .<span class="fn">normalize</span>()
      .<span class="fn">sharpen</span>({ sigma: <span class="num">1.5</span> })
      .<span class="fn">resize</span>({ width: <span class="num">3840</span>, kernel: <span class="str">'lanczos3'</span> })
      .<span class="fn">png</span>()
      .<span class="fn">toBuffer</span>();

    <span class="cmt">// 3. Run Tesseract WASM OCR</span>
    <span class="kw">const</span> { data } = <span class="kw">await this</span>.worker.<span class="fn">recognize</span>(processed);

    <span class="cmt">// 4. Extract word bounding boxes (filter low confidence)</span>
    <span class="kw">const</span> words: <span class="cls">OcrWord</span>[] = data.words
      .<span class="fn">filter</span>((w: <span class="kw">any</span>) =&gt; w.confidence &gt; <span class="num">60</span>)
      .<span class="fn">map</span>((w: <span class="kw">any</span>) =&gt; ({
        text: w.text.<span class="fn">trim</span>(),
        confidence: w.confidence,
        bbox: w.bbox,
        centerX: <span class="cls">Math</span>.<span class="fn">round</span>((w.bbox.x0 + w.bbox.x1) / <span class="num">2</span>),
        centerY: <span class="cls">Math</span>.<span class="fn">round</span>((w.bbox.y0 + w.bbox.y1) / <span class="num">2</span>),
      }));

    <span class="kw">return</span> words.<span class="fn">filter</span>(w =&gt; w.text.length &gt; <span class="num">0</span>);
  }

  <span class="cmt">/** Find and click a text element via OCR + LLM resolution */</span>
  <span class="kw">async</span> <span class="fn">ocrClick</span>(
    targetDescription: <span class="kw">string</span>,
    ai: <span class="cls">CometAiEngine</span>,
    robot: <span class="cls">RobotService</span>,
    perms: <span class="kw">any</span>
  ): <span class="cls">Promise</span>&lt;{ success: <span class="kw">boolean</span>; clickedText?: <span class="kw">string</span> }&gt; {

    <span class="kw">const</span> words = <span class="kw">await this</span>.<span class="fn">captureAndOcr</span>();

    <span class="cmt">// Fast path: direct text match</span>
    <span class="kw">const</span> directMatch = words.<span class="fn">find</span>(w =&gt;
      w.text.<span class="fn">toLowerCase</span>().<span class="fn">includes</span>(targetDescription.<span class="fn">toLowerCase</span>())
    );
    <span class="kw">if</span> (directMatch) {
      <span class="kw">await</span> robot.<span class="fn">execute</span>({
        type: <span class="str">'click'</span>,
        x: directMatch.centerX, y: directMatch.centerY,
        reason: <span class="str">`OCR direct click: "${directMatch.text}"`</span>
      }, perms);
      <span class="kw">return</span> { success: <span class="kw">true</span>, clickedText: directMatch.text };
    }

    <span class="cmt">// LLM resolution: let AI pick the best match</span>
    <span class="kw">const</span> wordList = words
      .<span class="fn">map</span>((w, i) =&gt; <span class="str">`[${i}] "${w.text}" at (${w.centerX}, ${w.centerY})`</span>)
      .<span class="fn">join</span>(<span class="str">'\n'</span>);

    <span class="kw">const</span> response = <span class="kw">await</span> ai.<span class="fn">chat</span>({
      model: <span class="str">'llama-3.1-8b-instant'</span>,
      systemPrompt: <span class="str">'You resolve UI click targets from OCR data. Respond with ONLY a JSON object: {"index": N, "text": "matched text"} or {"index": -1} if not found.'</span>,
      message: <span class="str">`Target: "${targetDescription}"\n\nOCR words:\n${wordList}`</span>,
    });

    <span class="kw">const</span> result = <span class="cls">JSON</span>.<span class="fn">parse</span>(response);
    <span class="kw">if</span> (result.index &lt; <span class="num">0</span>) <span class="kw">return</span> { success: <span class="kw">false</span> };

    <span class="kw">const</span> target = words[result.index];
    <span class="kw">await</span> robot.<span class="fn">execute</span>({
      type: <span class="str">'click'</span>,
      x: target.centerX, y: target.centerY,
      reason: <span class="str">`OCR LLM click: "${target.text}" (target: "${targetDescription}")`</span>
    }, perms);

    <span class="kw">return</span> { success: <span class="kw">true</span>, clickedText: target.text };
  }
}</code></pre>

  <div class="alert alert-tip">
    <div class="alert-icon">üí°</div>
    <div class="alert-body">Use <strong>sharp preprocessing</strong> (grayscale ‚Üí normalize ‚Üí sharpen ‚Üí 2√ó upscale) before OCR ‚Äî it dramatically improves accuracy on dark-themed or low-contrast apps. For retina/HiDPI displays, divide final coordinates by the display scale factor.</div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 8 ‚Äî SECURE ACTION GATING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="secgate">
  <div class="section-header">
    <div class="s-icon si-yellow">üîê</div>
    <h2>8. Secure Action Gating <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>Every desktop action goes through a <strong>PermissionStore</strong> ‚Äî a SQLite-backed registry that tracks which capabilities the user has explicitly enabled, with per-session or permanent grants and HMAC-signed audit trails.</p>

  <div class="gate-visual">
    <div class="flow-label" style="margin-bottom:16px">// Permission Levels (lowest ‚Üí highest risk)</div>
    <div class="gate-row">
      <div class="gate-node nn-green">READ</div>
      <span class="arr">‚Üí</span>
      <div class="gate-node nn-blue">INTERACT</div>
      <span class="arr">‚Üí</span>
      <div class="gate-node nn-purple">WRITE</div>
      <span class="arr">‚Üí</span>
      <div class="gate-node nn-orange">EXECUTE</div>
      <span class="arr">‚Üí</span>
      <div class="gate-node nn-red">SEND</div>
    </div>
    <p style="color:var(--text-muted);font-size:0.82rem;margin-top:12px">READ = view screen / read files | INTERACT = click / scroll | WRITE = type / edit files | EXECUTE = run scripts | SEND = external API / email</p>
  </div>

  <h3>permission-store.ts</h3>
  <pre><code><span class="cmt">// permission-store.ts ‚Äî SQLite-backed desktop permission registry</span>

<span class="kw">import</span> <span class="cls">Database</span> <span class="kw">from</span> <span class="str">'better-sqlite3'</span>;
<span class="kw">import</span> path <span class="kw">from</span> <span class="str">'path'</span>;
<span class="kw">import</span> { app } <span class="kw">from</span> <span class="str">'electron'</span>;

<span class="kw">type</span> <span class="cls">PermLevel</span> = <span class="str">'read'</span> | <span class="str">'interact'</span> | <span class="str">'write'</span> | <span class="str">'execute'</span> | <span class="str">'send'</span>;

<span class="kw">interface</span> <span class="cls">PermissionRow</span> {
  key: <span class="kw">string</span>;
  level: <span class="cls">PermLevel</span>;
  granted_at: <span class="kw">number</span>;
  expires_at: <span class="kw">number</span> | <span class="kw">null</span>; <span class="cmt">// null = permanent</span>
  description: <span class="kw">string</span>;
}

<span class="kw">export class</span> <span class="cls">PermissionStore</span> {
  <span class="kw">private</span> db!: <span class="cls">Database</span>.<span class="cls">Database</span>;

  <span class="kw">async</span> <span class="fn">load</span>(): <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt; {
    <span class="kw">const</span> dbPath = path.<span class="fn">join</span>(app.<span class="fn">getPath</span>(<span class="str">'userData'</span>), <span class="str">'comet-permissions.db'</span>);
    <span class="kw">this</span>.db = <span class="kw">new</span> <span class="cls">Database</span>(dbPath);
    <span class="kw">this</span>.db.<span class="fn">exec</span>(<span class="str">`
      CREATE TABLE IF NOT EXISTS permissions (
        key TEXT PRIMARY KEY,
        level TEXT NOT NULL,
        granted_at INTEGER NOT NULL,
        expires_at INTEGER,
        description TEXT
      );
      CREATE TABLE IF NOT EXISTS audit_log (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        entry TEXT NOT NULL,
        created_at INTEGER NOT NULL
      );
    `</span>);
  }

  <span class="fn">grant</span>(key: <span class="kw">string</span>, level: <span class="cls">PermLevel</span>, description: <span class="kw">string</span>, sessionOnly = <span class="kw">true</span>): <span class="kw">void</span> {
    <span class="kw">const</span> expiresAt = sessionOnly ? <span class="cls">Date</span>.<span class="fn">now</span>() + (<span class="num">8</span> * <span class="num">60</span> * <span class="num">60</span> * <span class="num">1000</span>) : <span class="kw">null</span>; <span class="cmt">// 8h or permanent</span>
    <span class="kw">this</span>.db.<span class="fn">prepare</span>(<span class="str">`
      INSERT OR REPLACE INTO permissions (key, level, granted_at, expires_at, description)
      VALUES (?, ?, ?, ?, ?)
    `</span>).<span class="fn">run</span>(key, level, <span class="cls">Date</span>.<span class="fn">now</span>(), expiresAt, description);
  }

  <span class="fn">revoke</span>(key: <span class="kw">string</span>): <span class="kw">void</span> {
    <span class="kw">this</span>.db.<span class="fn">prepare</span>(<span class="str">'DELETE FROM permissions WHERE key = ?'</span>).<span class="fn">run</span>(key);
  }

  <span class="fn">isGranted</span>(key: <span class="kw">string</span>): <span class="kw">boolean</span> {
    <span class="kw">const</span> row = <span class="kw">this</span>.db.<span class="fn">prepare</span>(<span class="str">'SELECT * FROM permissions WHERE key = ?'</span>)
      .<span class="fn">get</span>(key) <span class="kw">as</span> <span class="cls">PermissionRow</span> | <span class="kw">undefined</span>;
    <span class="kw">if</span> (!row) <span class="kw">return false</span>;
    <span class="kw">if</span> (row.expires_at && <span class="cls">Date</span>.<span class="fn">now</span>() &gt; row.expires_at) {
      <span class="kw">this</span>.<span class="fn">revoke</span>(key); <span class="cmt">// auto-expire</span>
      <span class="kw">return false</span>;
    }
    <span class="kw">return true</span>;
  }

  <span class="fn">logAudit</span>(entry: <span class="kw">string</span>): <span class="kw">void</span> {
    <span class="kw">this</span>.db.<span class="fn">prepare</span>(<span class="str">'INSERT INTO audit_log (entry, created_at) VALUES (?, ?)'</span>)
      .<span class="fn">run</span>(entry, <span class="cls">Date</span>.<span class="fn">now</span>());
  }
}</code></pre>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">üõë Emergency Kill Switch</div>
      <p>Register a global hotkey (Cmd/Ctrl+Shift+Esc) via Electron's <code>globalShortcut.register()</code> that sets a kill flag, aborts any pending RobotJS sequence, and revokes all session-level robot permissions immediately.</p>
    </div>
    <div class="card">
      <div class="card-title">üìã Always-Confirm Actions</div>
      <p>These action types MUST always show a confirmation dialog, even if <code>robot</code> permission is granted: <code>mouseClick</code>, <code>typeString</code>, form <code>submit</code>, file write, MCP send, and any external API call.</p>
    </div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 9 ‚Äî FLUTTER BRIDGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="flutter-bridge">
  <div class="section-header">
    <div class="s-icon si-orange">üì±</div>
    <h2>9. Flutter ‚Üî Electron Bridge <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>The Flutter companion app (mobile/tablet) communicates with the desktop Electron app via a <strong>local WebSocket server (socket.io)</strong> running inside Electron. This allows the mobile app to trigger AI actions on the desktop, and the desktop to push results, screen context, and status back to the phone.</p>

  <div class="flow">
    <div class="flow-label">// Flutter ‚Üî Electron Bridge Architecture</div>
    <div style="line-height:2.6">
      <span class="fn-node nn-orange">Flutter App (mobile)</span>
      <span class="arr">‚îÄ‚îÄ‚îÄ local Wi-Fi ‚îÄ‚îÄ‚Üí</span>
      <span class="fn-node nn-blue">Electron WebSocket Server (port 9876)</span>
      <br>
      <span style="padding-left:20px">
        <span class="fn-node nn-purple">Auth: HMAC shared secret</span><span class="arr"> + </span>
        <span class="fn-node nn-yellow">QR pairing flow</span>
      </span>
      <br>
      <span style="padding-left:20px">
        <span class="fn-node nn-cyan">Events: ai:chat, ocr:click, screen:describe, workflow:run</span>
      </span>
    </div>
  </div>

  <h3>bridge-server.ts ‚Äî Electron-side WebSocket</h3>
  <pre><code><span class="cmt">// bridge-server.ts ‚Äî Flutter ‚Üî Electron bridge
// Local socket.io server on port 9876, authenticated via shared secret</span>

<span class="kw">import</span> { <span class="cls">Server</span> } <span class="kw">from</span> <span class="str">'socket.io'</span>;
<span class="kw">import</span> { <span class="fn">createServer</span> } <span class="kw">from</span> <span class="str">'http'</span>;
<span class="kw">import</span> { <span class="fn">randomBytes</span>, <span class="fn">createHmac</span> } <span class="kw">from</span> <span class="str">'crypto'</span>;
<span class="kw">import</span> { <span class="cls">CometAiEngine</span> } <span class="kw">from</span> <span class="str">'./ai-engine'</span>;
<span class="kw">import</span> { <span class="cls">TesseractOcrService</span> } <span class="kw">from</span> <span class="str">'./tesseract-service'</span>;

<span class="kw">export class</span> <span class="cls">FlutterBridgeServer</span> {
  <span class="kw">private</span> io: <span class="cls">Server</span>;
  <span class="kw">private</span> secret: <span class="kw">string</span>;
  <span class="kw">private</span> connectedDevices = <span class="kw">new</span> <span class="cls">Map</span>&lt;<span class="kw">string</span>, <span class="kw">string</span>&gt;(); <span class="cmt">// socketId ‚Üí deviceId</span>

  <span class="fn">constructor</span>(
    <span class="kw">private</span> ai: <span class="cls">CometAiEngine</span>,
    <span class="kw">private</span> ocr: <span class="cls">TesseractOcrService</span>
  ) {
    <span class="kw">this</span>.secret = <span class="fn">randomBytes</span>(<span class="num">24</span>).<span class="fn">toString</span>(<span class="str">'hex'</span>); <span class="cmt">// shown as QR</span>
    <span class="kw">const</span> httpServer = <span class="fn">createServer</span>();
    <span class="kw">this</span>.io = <span class="kw">new</span> <span class="cls">Server</span>(httpServer, {
      cors: { origin: <span class="str">'*'</span>, methods: [<span class="str">'GET'</span>, <span class="str">'POST'</span>] }
    });

    <span class="kw">this</span>.io.<span class="fn">use</span>((socket, next) =&gt; {
      <span class="kw">const</span> token = socket.handshake.auth?.token;
      <span class="kw">if</span> (token !== <span class="kw">this</span>.secret) {
        <span class="kw">return</span> next(<span class="kw">new</span> <span class="cls">Error</span>(<span class="str">'Unauthorized'</span>));
      }
      next();
    });

    <span class="kw">this</span>.<span class="fn">setupHandlers</span>();
    httpServer.<span class="fn">listen</span>(<span class="num">9876</span>, <span class="str">'127.0.0.1'</span>); <span class="cmt">// localhost ONLY</span>
    console.<span class="fn">log</span>(<span class="str">'[Bridge] Flutter bridge ready on ws://127.0.0.1:9876'</span>);
  }

  <span class="kw">private</span> <span class="fn">setupHandlers</span>(): <span class="kw">void</span> {
    <span class="kw">this</span>.io.<span class="fn">on</span>(<span class="str">'connection'</span>, socket =&gt; {
      console.<span class="fn">log</span>(<span class="str">`[Bridge] Flutter device connected: ${socket.id}`</span>);
      <span class="kw">this</span>.connectedDevices.<span class="fn">set</span>(socket.id, socket.handshake.auth?.deviceId ?? socket.id);

      <span class="cmt">// Flutter ‚Üí Electron: AI chat with streaming</span>
      socket.<span class="fn">on</span>(<span class="str">'ai:chat'</span>, <span class="kw">async</span> ({ message, model }: <span class="kw">any</span>) =&gt; {
        <span class="kw">await</span> <span class="kw">this</span>.ai.<span class="fn">chat</span>({
          message, model: model ?? <span class="str">'llama-3.3-70b-versatile'</span>,
          onChunk: chunk =&gt; socket.<span class="fn">emit</span>(<span class="str">'ai:chunk'</span>, chunk),
        });
        socket.<span class="fn">emit</span>(<span class="str">'ai:done'</span>);
      });

      <span class="cmt">// Flutter ‚Üí Electron: trigger OCR click on desktop</span>
      socket.<span class="fn">on</span>(<span class="str">'ocr:click'</span>, <span class="kw">async</span> ({ target }: <span class="kw">any</span>) =&gt; {
        socket.<span class="fn">emit</span>(<span class="str">'ocr:status'</span>, <span class="str">'scanning'</span>);
        <span class="cmt">// Note: needs robot + perms injected for full flow</span>
        <span class="kw">const</span> words = <span class="kw">await this</span>.ocr.<span class="fn">captureAndOcr</span>();
        socket.<span class="fn">emit</span>(<span class="str">'ocr:result'</span>, { words: words.<span class="fn">slice</span>(<span class="num">0</span>, <span class="num">50</span>) });
      });

      <span class="cmt">// Flutter ‚Üí Electron: describe current screen</span>
      socket.<span class="fn">on</span>(<span class="str">'screen:describe'</span>, <span class="kw">async</span> () =&gt; {
        <span class="kw">const</span> words = <span class="kw">await this</span>.ocr.<span class="fn">captureAndOcr</span>();
        <span class="kw">const</span> context = words.<span class="fn">map</span>(w =&gt; w.text).<span class="fn">join</span>(<span class="str">' '</span>);
        <span class="kw">const</span> description = <span class="kw">await this</span>.ai.<span class="fn">chat</span>({
          model: <span class="str">'gemini-2.5-flash-preview'</span>,
          message: <span class="str">`Describe what's on this screen briefly in 1-2 sentences: ${context.slice(0, 2000)}`</span>
        });
        socket.<span class="fn">emit</span>(<span class="str">'screen:description'</span>, description);
      });

      socket.<span class="fn">on</span>(<span class="str">'disconnect'</span>, () =&gt; {
        <span class="kw">this</span>.connectedDevices.<span class="fn">delete</span>(socket.id);
      });
    });
  }

  <span class="cmt">/** Get QR pairing code (base64-encoded connection info) */</span>
  <span class="fn">getPairingCode</span>(): <span class="kw">string</span> {
    <span class="kw">return</span> <span class="cls">Buffer</span>.<span class="fn">from</span>(<span class="cls">JSON</span>.<span class="fn">stringify</span>({
      host: <span class="str">'127.0.0.1'</span>, port: <span class="num">9876</span>, secret: <span class="kw">this</span>.secret,
      version: <span class="str">'1.0'</span>, expires: <span class="cls">Date</span>.<span class="fn">now</span>() + <span class="num">300000</span>
    })).<span class="fn">toString</span>(<span class="str">'base64'</span>);
  }
}</code></pre>

  <h3>Flutter-side (Dart) ‚Äî Connecting to Bridge</h3>
  <pre><code><span class="cmt">// flutter_bridge_client.dart ‚Äî Connect to Electron desktop bridge</span>
<span class="kw">import</span> <span class="str">'package:socket_io_client/socket_io_client.dart'</span> as io;

<span class="kw">class</span> <span class="cls">ElectronBridgeClient</span> {
  io.<span class="cls">Socket</span>? _socket;
  <span class="kw">final</span> <span class="cls">StreamController</span>&lt;<span class="kw">String</span>&gt; _aiChunks = <span class="cls">StreamController</span>.broadcast();
  <span class="cls">Stream</span>&lt;<span class="kw">String</span>&gt; <span class="kw">get</span> aiChunks =&gt; _aiChunks.stream;

  <span class="kw">Future</span>&lt;<span class="kw">void</span>&gt; <span class="fn">connect</span>(<span class="kw">String</span> host, <span class="kw">int</span> port, <span class="kw">String</span> secret) <span class="kw">async</span> {
    _socket = io.<span class="fn">io</span>(<span class="str">'http://$host:$port'</span>, io.<span class="fn">OptionBuilder</span>()
      .<span class="fn">setTransports</span>([<span class="str">'websocket'</span>])
      .<span class="fn">setAuth</span>({<span class="str">'token'</span>: secret, <span class="str">'deviceId'</span>: <span class="str">'flutter-companion'</span>})
      .<span class="fn">enableAutoConnect</span>()
      .<span class="fn">build</span>());

    _socket!.<span class="fn">on</span>(<span class="str">'ai:chunk'</span>, (data) =&gt; _aiChunks.<span class="fn">add</span>(data <span class="kw">as</span> <span class="kw">String</span>));
  }

  <span class="kw">void</span> <span class="fn">sendChat</span>(<span class="kw">String</span> message, {<span class="kw">String</span>? model}) {
    _socket?.<span class="fn">emit</span>(<span class="str">'ai:chat'</span>, {<span class="str">'message'</span>: message, <span class="str">'model'</span>: model});
  }

  <span class="kw">void</span> <span class="fn">clickOnDesktop</span>(<span class="kw">String</span> target) {
    _socket?.<span class="fn">emit</span>(<span class="str">'ocr:click'</span>, {<span class="str">'target'</span>: target});
  }

  <span class="kw">void</span> <span class="fn">describeScreen</span>() {
    _socket?.<span class="fn">emit</span>(<span class="str">'screen:describe'</span>);
  }
}</code></pre>

  <div class="alert alert-warn">
    <div class="alert-icon">‚ö†Ô∏è</div>
    <div class="alert-body">The WebSocket server must bind to <code>127.0.0.1</code> (localhost) only ‚Äî never <code>0.0.0.0</code>. The flutter app connects over local LAN, so the shared secret provides authentication. Rotate the secret on every app launch; display it as a QR code for easy pairing.</div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 10 ‚Äî MCP ENHANCED
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="mcp">
  <div class="section-header">
    <div class="s-icon si-cyan">üîå</div>
    <h2>10. MCP Enhanced (v2) <span class="new-feature">‚òÖ Desktop Additions</span></h2>
  </div>
  <p>Comet-AI Desktop extends the Model Context Protocol with new desktop-only servers. Beyond the original Gmail/GitHub/Notion integrations, the Electron version adds FileSystem, NativeApp (AppleScript/PowerShell), ScreenContext (OCR as a tool), and Flutter bridge MCP servers.</p>

  <div class="mcp-grid">
    <div class="mcp-card">
      <div class="mcp-title">üìß Gmail MCP <span class="mcp-status mcp-official">Official</span></div>
      <p class="model-desc">Read, send, search, and label emails. Requires OAuth scopes.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üêô GitHub MCP <span class="mcp-status mcp-official">Official</span></div>
      <p class="model-desc">Issues, PRs, commits, code search, file access.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üìù Notion MCP <span class="mcp-status mcp-community">Community</span></div>
      <p class="model-desc">Pages, databases, blocks. Read + write with user approval.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üìÅ FileSystem MCP <span class="mcp-status mcp-new">Desktop New</span></div>
      <p class="model-desc">Read/write approved directories. Dir whitelist, no traversal.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üñ•Ô∏è NativeApp MCP <span class="mcp-status mcp-new">Desktop New</span></div>
      <p class="model-desc">AppleScript (macOS) / PowerShell (Windows) native app control.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üëÅÔ∏è ScreenContext MCP <span class="mcp-status mcp-new">Desktop New</span></div>
      <p class="model-desc">OCR screen capture exposed as a readable MCP tool/resource.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üì± Flutter Bridge MCP <span class="mcp-status mcp-new">Desktop New</span></div>
      <p class="model-desc">Send actions and queries to Flutter companion app via WebSocket.</p>
    </div>
    <div class="mcp-card">
      <div class="mcp-title">üóÇÔ∏è Slack MCP <span class="mcp-status mcp-official">Official</span></div>
      <p class="model-desc">Read channels, post messages, manage DMs. Bot token required.</p>
    </div>
  </div>

  <h3>mcp-desktop-server.ts ‚Äî FileSystem + NativeApp Servers</h3>
  <pre><code><span class="cmt">// mcp-desktop-server.ts ‚Äî Desktop-only MCP servers
// FileSystem (sandboxed) + NativeApp (AppleScript/PowerShell)</span>

<span class="kw">import</span> { <span class="cls">McpServer</span> } <span class="kw">from</span> <span class="str">'@modelcontextprotocol/sdk/server/mcp'</span>;
<span class="kw">import</span> { z } <span class="kw">from</span> <span class="str">'zod'</span>;
<span class="kw">import</span> fs <span class="kw">from</span> <span class="str">'fs/promises'</span>;
<span class="kw">import</span> path <span class="kw">from</span> <span class="str">'path'</span>;
<span class="kw">import</span> { <span class="fn">exec</span> } <span class="kw">from</span> <span class="str">'child_process'</span>;
<span class="kw">import</span> { <span class="fn">promisify</span> } <span class="kw">from</span> <span class="str">'util'</span>;
<span class="kw">import</span> os <span class="kw">from</span> <span class="str">'os'</span>;

<span class="kw">const</span> execAsync = <span class="fn">promisify</span>(exec);

<span class="cmt">// Approved directory whitelist ‚Äî never allow .. traversal</span>
<span class="kw">const</span> APPROVED_DIRS = [
  path.<span class="fn">join</span>(os.<span class="fn">homedir</span>(), <span class="str">'Documents'</span>),
  path.<span class="fn">join</span>(os.<span class="fn">homedir</span>(), <span class="str">'Downloads'</span>),
  path.<span class="fn">join</span>(os.<span class="fn">homedir</span>(), <span class="str">'Desktop'</span>),
];

<span class="kw">function</span> <span class="fn">assertApprovedPath</span>(filePath: <span class="kw">string</span>): <span class="kw">void</span> {
  <span class="kw">const</span> resolved = path.<span class="fn">resolve</span>(filePath);
  <span class="kw">const</span> ok = APPROVED_DIRS.<span class="fn">some</span>(d =&gt; resolved.<span class="fn">startsWith</span>(d));
  <span class="kw">if</span> (!ok) <span class="kw">throw new</span> <span class="cls">Error</span>(<span class="str">`Path not in approved directories: ${resolved}`</span>);
}

<span class="kw">export function</span> <span class="fn">createFileSystemMcp</span>(): <span class="cls">McpServer</span> {
  <span class="kw">const</span> server = <span class="kw">new</span> <span class="cls">McpServer</span>({ name: <span class="str">'filesystem'</span>, version: <span class="str">'1.0'</span> });

  server.<span class="fn">tool</span>(<span class="str">'read_file'</span>, { path: z.<span class="fn">string</span>() }, <span class="kw">async</span> ({ path: p }) =&gt; {
    <span class="fn">assertApprovedPath</span>(p);
    <span class="kw">const</span> content = <span class="kw">await</span> fs.<span class="fn">readFile</span>(p, <span class="str">'utf-8'</span>);
    <span class="kw">return</span> { content: [{ type: <span class="str">'text'</span>, text: content.<span class="fn">slice</span>(<span class="num">0</span>, <span class="num">32000</span>) }] };
  });

  server.<span class="fn">tool</span>(<span class="str">'write_file'</span>, { path: z.<span class="fn">string</span>(), content: z.<span class="fn">string</span>() },
    <span class="kw">async</span> ({ path: p, content }) =&gt; {
      <span class="fn">assertApprovedPath</span>(p);
      <span class="kw">await</span> fs.<span class="fn">writeFile</span>(p, content, <span class="str">'utf-8'</span>);
      <span class="kw">return</span> { content: [{ type: <span class="str">'text'</span>, text: <span class="str">`Written: ${p}`</span> }] };
    });

  server.<span class="fn">tool</span>(<span class="str">'list_dir'</span>, { path: z.<span class="fn">string</span>() }, <span class="kw">async</span> ({ path: p }) =&gt; {
    <span class="fn">assertApprovedPath</span>(p);
    <span class="kw">const</span> entries = <span class="kw">await</span> fs.<span class="fn">readdir</span>(p, { withFileTypes: <span class="kw">true</span> });
    <span class="kw">const</span> list = entries.<span class="fn">map</span>(e =&gt; <span class="str">`${e.isDirectory() ? 'üìÅ' : 'üìÑ'} ${e.name}`</span>).<span class="fn">join</span>(<span class="str">'\n'</span>);
    <span class="kw">return</span> { content: [{ type: <span class="str">'text'</span>, text: list }] };
  });

  <span class="kw">return</span> server;
}

<span class="kw">export function</span> <span class="fn">createNativeAppMcp</span>(): <span class="cls">McpServer</span> {
  <span class="kw">const</span> server = <span class="kw">new</span> <span class="cls">McpServer</span>({ name: <span class="str">'native-app'</span>, version: <span class="str">'1.0'</span> });

  server.<span class="fn">tool</span>(<span class="str">'run_applescript'</span>, { script: z.<span class="fn">string</span>().<span class="fn">max</span>(<span class="num">2000</span>) },
    <span class="kw">async</span> ({ script }) =&gt; {
      <span class="kw">if</span> (process.platform !== <span class="str">'darwin'</span>) {
        <span class="kw">throw new</span> <span class="cls">Error</span>(<span class="str">'AppleScript only on macOS'</span>);
      }
      <span class="cmt">// Dangerous ‚Äî only allow safelisted app targets</span>
      <span class="kw">const</span> ALLOWED_APPS = [<span class="str">'Safari'</span>, <span class="str">'Notes'</span>, <span class="str">'Calendar'</span>, <span class="str">'Mail'</span>];
      <span class="kw">const</span> hasAllow = ALLOWED_APPS.<span class="fn">some</span>(app =&gt; script.<span class="fn">includes</span>(app));
      <span class="kw">if</span> (!hasAllow) <span class="kw">throw new</span> <span class="cls">Error</span>(<span class="str">'AppleScript: no allowed app target in script'</span>);

      <span class="kw">const</span> { stdout } = <span class="kw">await</span> <span class="fn">execAsync</span>(<span class="str">`osascript -e '${script.replace(/'/g, "\\'")}'`</span>);
      <span class="kw">return</span> { content: [{ type: <span class="str">'text'</span>, text: stdout }] };
    });

  <span class="kw">return</span> server;
}</code></pre>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 11 ‚Äî WEB SEARCH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="web-search">
  <div class="section-header">
    <div class="s-icon si-blue">üîç</div>
    <h2>11. Web Search Integration</h2>
  </div>
  <p>Comet-AI Desktop supports three search providers ‚Äî Brave (privacy-first, no tracking), Tavily (AI-optimized with summaries), and SerpAPI (comprehensive Google results). All run via Axios in the main process and results are injected into the LLM context window.</p>

  <table>
    <thead><tr><th>Provider</th><th>Best For</th><th>Free Tier</th><th>Key Env Var</th></tr></thead>
    <tbody>
      <tr><td class="mono">Brave Search</td><td>Privacy-first, real-time web</td><td>2,000/mo</td><td class="mono">BRAVE_API_KEY</td></tr>
      <tr><td class="mono">Tavily</td><td>AI-optimized, summarized results</td><td>1,000/mo</td><td class="mono">TAVILY_API_KEY</td></tr>
      <tr><td class="mono">SerpAPI</td><td>Google results, news, shopping</td><td>100/mo</td><td class="mono">SERP_API_KEY</td></tr>
    </tbody>
  </table>

  <pre><code><span class="cmt">// web-search-service.ts ‚Äî Multi-provider web search</span>
<span class="kw">import</span> axios <span class="kw">from</span> <span class="str">'axios'</span>;

<span class="kw">export interface</span> <span class="cls">SearchResult</span> {
  title: <span class="kw">string</span>;
  url: <span class="kw">string</span>;
  snippet: <span class="kw">string</span>;
}

<span class="kw">export class</span> <span class="cls">WebSearchService</span> {
  <span class="kw">async</span> <span class="fn">search</span>(query: <span class="kw">string</span>, provider: <span class="str">'brave'</span> | <span class="str">'tavily'</span> | <span class="str">'serp'</span> = <span class="str">'brave'</span>): <span class="cls">Promise</span>&lt;<span class="cls">SearchResult</span>[]&gt; {
    <span class="kw">switch</span> (provider) {
      <span class="kw">case</span> <span class="str">'brave'</span>: <span class="kw">return this</span>.<span class="fn">searchBrave</span>(query);
      <span class="kw">case</span> <span class="str">'tavily'</span>: <span class="kw">return this</span>.<span class="fn">searchTavily</span>(query);
      <span class="kw">case</span> <span class="str">'serp'</span>: <span class="kw">return this</span>.<span class="fn">searchSerp</span>(query);
    }
  }

  <span class="kw">private async</span> <span class="fn">searchBrave</span>(query: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="cls">SearchResult</span>[]&gt; {
    <span class="kw">const</span> res = <span class="kw">await</span> axios.<span class="fn">get</span>(<span class="str">'https://api.search.brave.com/res/v1/web/search'</span>, {
      params: { q: query, count: <span class="num">8</span> },
      headers: { <span class="str">'X-Subscription-Token'</span>: process.env.BRAVE_API_KEY }
    });
    <span class="kw">return</span> res.data.web?.results?.<span class="fn">map</span>((r: <span class="kw">any</span>) =&gt; ({
      title: r.title, url: r.url, snippet: r.description ?? <span class="str">''</span>
    })) ?? [];
  }

  <span class="kw">private async</span> <span class="fn">searchTavily</span>(query: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="cls">SearchResult</span>[]&gt; {
    <span class="kw">const</span> res = <span class="kw">await</span> axios.<span class="fn">post</span>(<span class="str">'https://api.tavily.com/search'</span>, {
      api_key: process.env.TAVILY_API_KEY,
      query, search_depth: <span class="str">'basic'</span>, max_results: <span class="num">8</span>,
    });
    <span class="kw">return</span> res.data.results?.<span class="fn">map</span>((r: <span class="kw">any</span>) =&gt; ({
      title: r.title, url: r.url, snippet: r.content ?? <span class="str">''</span>
    })) ?? [];
  }

  <span class="kw">private async</span> <span class="fn">searchSerp</span>(query: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="cls">SearchResult</span>[]&gt; {
    <span class="kw">const</span> res = <span class="kw">await</span> axios.<span class="fn">get</span>(<span class="str">'https://serpapi.com/search'</span>, {
      params: { q: query, api_key: process.env.SERP_API_KEY, num: <span class="num">8</span>, engine: <span class="str">'google'</span> }
    });
    <span class="kw">return</span> res.data.organic_results?.<span class="fn">map</span>((r: <span class="kw">any</span>) =&gt; ({
      title: r.title, url: r.link, snippet: r.snippet ?? <span class="str">''</span>
    })) ?? [];
  }
}</code></pre>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 12 ‚Äî RAG + VECTOR DB
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="rag">
  <div class="section-header">
    <div class="s-icon si-green">üß†</div>
    <h2>12. RAG + Local Vector DB (LanceDB)</h2>
  </div>
  <p>Comet-AI Desktop uses <strong>LanceDB</strong> (the better-supported desktop alternative to ObjectBox) for local vector storage. Documents are chunked, embedded, and stored on-device. Retrieval augments every AI query with relevant private context.</p>

  <pre><code><span class="cmt">// rag-service.ts ‚Äî LanceDB local vector RAG
// Embeds text with Gemini embedding API, stores in LanceDB</span>

<span class="kw">import</span> * <span class="kw">as</span> lancedb <span class="kw">from</span> <span class="str">'lancedb'</span>;
<span class="kw">import</span> { app } <span class="kw">from</span> <span class="str">'electron'</span>;
<span class="kw">import</span> path <span class="kw">from</span> <span class="str">'path'</span>;

<span class="kw">interface</span> <span class="cls">DocChunk</span> {
  id: <span class="kw">string</span>;
  text: <span class="kw">string</span>;
  source: <span class="kw">string</span>;
  vector: <span class="kw">number</span>[];
}

<span class="kw">export class</span> <span class="cls">RagService</span> {
  <span class="kw">private</span> db!: <span class="kw">any</span>;
  <span class="kw">private</span> table!: <span class="kw">any</span>;

  <span class="kw">async</span> <span class="fn">init</span>(): <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt; {
    <span class="kw">const</span> dbPath = path.<span class="fn">join</span>(app.<span class="fn">getPath</span>(<span class="str">'userData'</span>), <span class="str">'rag-vectors'</span>);
    <span class="kw">this</span>.db = <span class="kw">await</span> lancedb.<span class="fn">connect</span>(dbPath);
    <span class="kw">try</span> {
      <span class="kw">this</span>.table = <span class="kw">await this</span>.db.<span class="fn">openTable</span>(<span class="str">'chunks'</span>);
    } <span class="kw">catch</span> {
      <span class="kw">this</span>.table = <span class="kw">await this</span>.db.<span class="fn">createTable</span>(<span class="str">'chunks'</span>, []);
    }
  }

  <span class="kw">async</span> <span class="fn">embed</span>(text: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="kw">number</span>[]&gt; {
    <span class="kw">const</span> res = <span class="kw">await</span> fetch(
      <span class="str">`https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key=${process.env.GEMINI_API_KEY}`</span>,
      { method: <span class="str">'POST'</span>, body: <span class="cls">JSON</span>.<span class="fn">stringify</span>({ content: { parts: [{ text }] } }) }
    );
    <span class="kw">const</span> data = <span class="kw">await</span> res.<span class="fn">json</span>();
    <span class="kw">return</span> data.embedding.values;
  }

  <span class="kw">async</span> <span class="fn">ingest</span>(text: <span class="kw">string</span>, source: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt; {
    <span class="kw">const</span> chunks = <span class="kw">this</span>.<span class="fn">chunkText</span>(text);
    <span class="kw">const</span> rows: <span class="cls">DocChunk</span>[] = [];
    <span class="kw">for</span> (<span class="kw">const</span> [i, chunk] <span class="kw">of</span> chunks.<span class="fn">entries</span>()) {
      rows.<span class="fn">push</span>({
        id: <span class="str">`${source}-${i}`</span>, text: chunk, source,
        vector: <span class="kw">await this</span>.<span class="fn">embed</span>(chunk)
      });
    }
    <span class="kw">await this</span>.table.<span class="fn">add</span>(rows);
  }

  <span class="kw">async</span> <span class="fn">retrieve</span>(query: <span class="kw">string</span>, k = <span class="num">4</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>[]&gt; {
    <span class="kw">const</span> qVec = <span class="kw">await this</span>.<span class="fn">embed</span>(query);
    <span class="kw">const</span> results = <span class="kw">await this</span>.table.<span class="fn">search</span>(qVec).<span class="fn">limit</span>(k).<span class="fn">toArray</span>();
    <span class="kw">return</span> results.<span class="fn">map</span>((r: <span class="cls">DocChunk</span>) =&gt; r.text);
  }

  <span class="kw">private</span> <span class="fn">chunkText</span>(text: <span class="kw">string</span>, size = <span class="num">512</span>): <span class="kw">string</span>[] {
    <span class="kw">const</span> words = text.<span class="fn">split</span>(<span class="str">/\s+/</span>);
    <span class="kw">const</span> chunks: <span class="kw">string</span>[] = [];
    <span class="kw">for</span> (<span class="kw">let</span> i = <span class="num">0</span>; i &lt; words.length; i += size) {
      chunks.<span class="fn">push</span>(words.<span class="fn">slice</span>(i, i + size).<span class="fn">join</span>(<span class="str">' '</span>));
    }
    <span class="kw">return</span> chunks;
  }
}</code></pre>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 13 ‚Äî SCREEN CAPTURE AI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="screen-capture">
  <div class="section-header">
    <div class="s-icon si-purple">üì∫</div>
    <h2>13. Screen Capture & Vision AI <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>Comet-AI Desktop can describe, analyze, and act on the current screen using multimodal vision AI. Uses Electron's <code>desktopCapturer</code> API to grab a screenshot and sends it as a base64 image to Claude Sonnet's vision endpoint.</p>

  <pre><code><span class="cmt">// screen-vision-service.ts ‚Äî AI-powered screen understanding</span>

<span class="kw">import</span> { desktopCapturer } <span class="kw">from</span> <span class="str">'electron'</span>;
<span class="kw">import</span> <span class="cls">Anthropic</span> <span class="kw">from</span> <span class="str">'@anthropic-ai/sdk'</span>;

<span class="kw">export class</span> <span class="cls">ScreenVisionService</span> {
  <span class="kw">private</span> anthropic = <span class="kw">new</span> <span class="cls">Anthropic</span>({ apiKey: process.env.ANTHROPIC_API_KEY });

  <span class="kw">async</span> <span class="fn">captureBase64</span>(): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> sources = <span class="kw">await</span> desktopCapturer.<span class="fn">getSources</span>({
      types: [<span class="str">'screen'</span>],
      thumbnailSize: { width: <span class="num">1920</span>, height: <span class="num">1080</span> }
    });
    <span class="kw">return</span> sources[<span class="num">0</span>].thumbnail.<span class="fn">toJPEG</span>(<span class="num">85</span>).<span class="fn">toString</span>(<span class="str">'base64'</span>);
  }

  <span class="kw">async</span> <span class="fn">describe</span>(question?: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> imageData = <span class="kw">await this</span>.<span class="fn">captureBase64</span>();
    <span class="kw">const</span> response = <span class="kw">await this</span>.anthropic.messages.<span class="fn">create</span>({
      model: <span class="str">'claude-sonnet-4-6'</span>,
      max_tokens: <span class="num">1024</span>,
      messages: [{
        role: <span class="str">'user'</span>,
        content: [
          { type: <span class="str">'image'</span>, source: { type: <span class="str">'base64'</span>, media_type: <span class="str">'image/jpeg'</span>, data: imageData } },
          { type: <span class="str">'text'</span>, text: question ?? <span class="str">'Describe what is currently displayed on this screen in 2-3 sentences.'</span> }
        ]
      }]
    });
    <span class="kw">return</span> (response.content[<span class="num">0</span>] <span class="kw">as any</span>).text;
  }
}</code></pre>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 14 ‚Äî VOICE CONTROL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="voice">
  <div class="section-header">
    <div class="s-icon si-orange">üé§</div>
    <h2>14. Voice Control <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>Users can speak commands to Comet-AI Desktop. The app captures audio via the OS microphone (gated by Electron permission request), transcribes via OpenAI Whisper, and routes the text through the normal AI + robot pipeline.</p>

  <pre><code><span class="cmt">// voice-service.ts ‚Äî Mic capture ‚Üí Whisper transcription ‚Üí AI command</span>

<span class="kw">import</span> { systemPreferences, ipcMain } <span class="kw">from</span> <span class="str">'electron'</span>;
<span class="kw">import</span> { <span class="cls">OpenAI</span> } <span class="kw">from</span> <span class="str">'openai'</span>;
<span class="kw">import</span> fs <span class="kw">from</span> <span class="str">'fs'</span>;
<span class="kw">import</span> os <span class="kw">from</span> <span class="str">'os'</span>;
<span class="kw">import</span> path <span class="kw">from</span> <span class="str">'path'</span>;

<span class="kw">export class</span> <span class="cls">VoiceService</span> {
  <span class="kw">private</span> openai = <span class="kw">new</span> <span class="cls">OpenAI</span>({ apiKey: process.env.OPENAI_API_KEY });

  <span class="kw">async</span> <span class="fn">requestMicPermission</span>(): <span class="cls">Promise</span>&lt;<span class="kw">boolean</span>&gt; {
    <span class="kw">if</span> (process.platform !== <span class="str">'darwin'</span>) <span class="kw">return true</span>; <span class="cmt">// Windows: no prompt needed</span>
    <span class="kw">const</span> status = <span class="kw">await</span> systemPreferences.<span class="fn">askForMediaAccess</span>(<span class="str">'microphone'</span>);
    <span class="kw">return</span> status;
  }

  <span class="kw">async</span> <span class="fn">transcribeFile</span>(audioPath: <span class="kw">string</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">const</span> transcription = <span class="kw">await this</span>.openai.audio.transcriptions.<span class="fn">create</span>({
      file: fs.<span class="fn">createReadStream</span>(audioPath),
      model: <span class="str">'whisper-1'</span>,
      language: <span class="str">'en'</span>,
      response_format: <span class="str">'text'</span>
    });
    <span class="kw">return</span> transcription <span class="kw">as</span> <span class="kw">string</span>;
  }
}

<span class="cmt">// In main.ts ‚Äî register voice IPC handlers</span>
ipcMain.<span class="fn">handle</span>(<span class="str">'voice:transcribe'</span>, <span class="kw">async</span> (_, audioBase64: <span class="kw">string</span>) =&gt; {
  <span class="kw">const</span> tmpPath = path.<span class="fn">join</span>(os.<span class="fn">tmpdir</span>(), <span class="str">'comet-voice.wav'</span>);
  fs.<span class="fn">writeFileSync</span>(tmpPath, <span class="cls">Buffer</span>.<span class="fn">from</span>(audioBase64, <span class="str">'base64'</span>));
  <span class="kw">const</span> voice = <span class="kw">new</span> <span class="cls">VoiceService</span>();
  <span class="kw">const</span> text = <span class="kw">await</span> voice.<span class="fn">transcribeFile</span>(tmpPath);
  fs.<span class="fn">unlinkSync</span>(tmpPath); <span class="cmt">// delete temp audio</span>
  <span class="kw">return</span> text;
});</code></pre>

  <div class="alert alert-info">
    <div class="alert-icon">‚ÑπÔ∏è</div>
    <div class="alert-body">Record audio in the renderer using the Web Audio API (<code>MediaRecorder</code>), export as WAV blob, encode as base64, and send via <code>cometBridge.transcribeVoice(base64)</code>. The mic permission request dialog is shown to the user only once per session.</div>
  </div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 15 ‚Äî WORKFLOW RECORDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="workflow">
  <div class="section-header">
    <div class="s-icon si-green">üîÑ</div>
    <h2>15. Workflow Recorder & Replay <span class="new-feature">‚òÖ New</span></h2>
  </div>
  <p>Users can record a sequence of AI actions (clicks, keystrokes, searches, MCP calls) with timing, save them as named JSON workflows, and replay them later with natural language triggers like <em>"run my morning email workflow"</em>.</p>

  <pre><code><span class="cmt">// workflow-recorder.ts ‚Äî Record and replay agentic action sequences</span>

<span class="kw">import</span> fs <span class="kw">from</span> <span class="str">'fs/promises'</span>;
<span class="kw">import</span> path <span class="kw">from</span> <span class="str">'path'</span>;
<span class="kw">import</span> { app } <span class="kw">from</span> <span class="str">'electron'</span>;

<span class="kw">interface</span> <span class="cls">WorkflowStep</span> {
  type: <span class="str">'robot'</span> | <span class="str">'ai'</span> | <span class="str">'ocr'</span> | <span class="str">'mcp'</span>;
  action: <span class="kw">unknown</span>;
  delay: <span class="kw">number</span>; <span class="cmt">// ms since last step</span>
  timestamp: <span class="kw">number</span>;
}

<span class="kw">interface</span> <span class="cls">Workflow</span> {
  name: <span class="kw">string</span>;
  description: <span class="kw">string</span>;
  steps: <span class="cls">WorkflowStep</span>[];
  created: <span class="kw">number</span>;
}

<span class="kw">export class</span> <span class="cls">WorkflowRecorder</span> {
  <span class="kw">private</span> recording: <span class="cls">WorkflowStep</span>[] = [];
  <span class="kw">private</span> isRecording = <span class="kw">false</span>;
  <span class="kw">private</span> lastStep = <span class="num">0</span>;
  <span class="kw">private</span> workflowDir = path.<span class="fn">join</span>(app.<span class="fn">getPath</span>(<span class="str">'userData'</span>), <span class="str">'workflows'</span>);

  <span class="fn">start</span>(): <span class="kw">void</span> {
    <span class="kw">this</span>.recording = [];
    <span class="kw">this</span>.isRecording = <span class="kw">true</span>;
    <span class="kw">this</span>.lastStep = <span class="cls">Date</span>.<span class="fn">now</span>();
    console.<span class="fn">log</span>(<span class="str">'[Workflow] Recording started'</span>);
  }

  <span class="fn">record</span>(type: <span class="cls">WorkflowStep</span>[<span class="str">'type'</span>], action: <span class="kw">unknown</span>): <span class="kw">void</span> {
    <span class="kw">if</span> (!<span class="kw">this</span>.isRecording) <span class="kw">return</span>;
    <span class="kw">const</span> now = <span class="cls">Date</span>.<span class="fn">now</span>();
    <span class="kw">this</span>.recording.<span class="fn">push</span>({
      type, action,
      delay: now - <span class="kw">this</span>.lastStep,
      timestamp: now
    });
    <span class="kw">this</span>.lastStep = now;
  }

  <span class="kw">async</span> <span class="fn">save</span>(name: <span class="kw">string</span>, description = <span class="str">''</span>): <span class="cls">Promise</span>&lt;<span class="kw">string</span>&gt; {
    <span class="kw">this</span>.isRecording = <span class="kw">false</span>;
    <span class="kw">const</span> workflow: <span class="cls">Workflow</span> = {
      name, description, steps: <span class="kw">this</span>.recording, created: <span class="cls">Date</span>.<span class="fn">now</span>()
    };
    <span class="kw">await</span> fs.<span class="fn">mkdir</span>(<span class="kw">this</span>.workflowDir, { recursive: <span class="kw">true</span> });
    <span class="kw">const</span> filePath = path.<span class="fn">join</span>(<span class="kw">this</span>.workflowDir, <span class="str">`${name.<span class="fn">replace</span>(/\s/g, '-')}.json`</span>);
    <span class="kw">await</span> fs.<span class="fn">writeFile</span>(filePath, <span class="cls">JSON</span>.<span class="fn">stringify</span>(workflow, <span class="kw">null</span>, <span class="num">2</span>));
    <span class="kw">return</span> filePath;
  }

  <span class="kw">async</span> <span class="fn">replay</span>(name: <span class="kw">string</span>, executor: (step: <span class="cls">WorkflowStep</span>) =&gt; <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt;): <span class="cls">Promise</span>&lt;<span class="kw">void</span>&gt; {
    <span class="kw">const</span> filePath = path.<span class="fn">join</span>(<span class="kw">this</span>.workflowDir, <span class="str">`${name.<span class="fn">replace</span>(/\s/g, '-')}.json`</span>);
    <span class="kw">const</span> workflow: <span class="cls">Workflow</span> = <span class="cls">JSON</span>.<span class="fn">parse</span>(<span class="kw">await</span> fs.<span class="fn">readFile</span>(filePath, <span class="str">'utf-8'</span>));

    <span class="kw">for</span> (<span class="kw">const</span> step <span class="kw">of</span> workflow.steps) {
      <span class="kw">if</span> (step.delay &gt; <span class="num">0</span>) {
        <span class="kw">await</span> <span class="kw">new</span> <span class="cls">Promise</span>(r =&gt; <span class="fn">setTimeout</span>(r, <span class="cls">Math</span>.<span class="fn">min</span>(step.delay, <span class="num">2000</span>))); <span class="cmt">// cap replay delay at 2s</span>
      }
      <span class="kw">await</span> <span class="fn">executor</span>(step);
    }
  }
}</code></pre>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SECTION 16 ‚Äî TIPS & BEST PRACTICES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section id="tips">
  <div class="section-header">
    <div class="s-icon si-cyan">‚≠ê</div>
    <h2>16. Tips & Best Practices</h2>
  </div>

  <div class="grid-2">
    <div class="skill-card">
      <div class="skill-header">
        <span class="skill-badge">Security</span>
        <strong>Never enable nodeIntegration</strong>
      </div>
      <p>Any window loading external URLs must have <code>nodeIntegration: false</code> and <code>contextIsolation: true</code>. Use the preload script and contextBridge exclusively for renderer ‚Üî main communication.</p>
    </div>
    <div class="skill-card">
      <div class="skill-header">
        <span class="skill-badge">Robot</span>
        <strong>Rebuild native modules</strong>
      </div>
      <p>Run <code>npm run rebuild</code> (electron-rebuild) every time you switch Electron versions or install new native packages. RobotJS and better-sqlite3 are both native and must match Electron's Node ABI.</p>
    </div>
    <div class="skill-card">
      <div class="skill-header">
        <span class="skill-badge">OCR</span>
        <strong>Preprocess before OCR</strong>
      </div>
      <p>Always run sharp preprocessing (grayscale ‚Üí normalize ‚Üí sharpen ‚Üí 2√ó upscale) before feeding images to Tesseract. This alone can improve accuracy from 60% to 90%+ on modern dark UI apps.</p>
    </div>
    <div class="skill-card">
      <div class="skill-header">
        <span class="skill-badge">Models</span>
        <strong>Use the right model per task</strong>
      </div>
      <p>Robot action planning ‚Üí Groq llama-3.3-70b (fast). OCR resolution ‚Üí llama-3.1-8b-instant (tiny + instant). Screen vision ‚Üí claude-sonnet-4-6 (vision). Complex agentic ‚Üí gemini-2.5-pro.</p>
    </div>
    <div class="skill-card">
      <div class="skill-header">
        <span class="skill-badge">Keys</span>
        <strong>Use safeStorage for API keys</strong>
      </div>
      <p>Never store API keys in plain text or in <code>.env</code> files bundled with the app. Use Electron's <code>safeStorage</code> to encrypt keys with the OS keychain. Only decrypt in the main process.</p>
    </div>
    <div class="skill-card">
      <div class="skill-header">
        <span class="skill-badge">Bridge</span>
        <strong>Rotate bridge secret on launch</strong>
      </div>
      <p>Generate a new <code>crypto.randomBytes(24)</code> secret every time the Electron app launches. Display it as a QR code for the Flutter app to pair. Never hardcode or persist the secret.</p>
    </div>
  </div>

  <h3>Critical Security Checklist</h3>
  <div class="card">
    <table>
      <thead><tr><th>Rule</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>contextIsolation: true in all BrowserWindow configs</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>nodeIntegration: false in all BrowserWindow configs</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>CometSecurityService.classify() before every LLM call</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>User confirmation dialog before any robot write action</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>Emergency kill shortcut (Cmd/Ctrl+Shift+Esc) registered</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>RobotJS coordinate bounds-checked before every click</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>Flutter bridge bound to 127.0.0.1 only (never 0.0.0.0)</td><td style="color:var(--accent-green)">‚úÖ Required</td></tr>
        <tr><td>API keys stored via safeStorage, never in env files</td><td style="color:var(--accent-orange)">‚ö†Ô∏è Recommended</td></tr>
        <tr><td>Audit log written before action execution, not after</td><td style="color:var(--accent-orange)">‚ö†Ô∏è Recommended</td></tr>
        <tr><td>300ms minimum delay between consecutive robot actions</td><td style="color:var(--accent-orange)">‚ö†Ô∏è Recommended</td></tr>
      </tbody>
    </table>
  </div>

  <div class="alert alert-tip">
    <div class="alert-icon">üí°</div>
    <div class="alert-body"><strong>Pro tip:</strong> Start with the Groq <code>llama-3.1-8b-instant</code> model for all rapid classification and routing tasks. Its sub-100ms latency makes the UI feel snappy. Reserve Gemini Pro and GPT-5 for complex reasoning tasks that actually need the extra power.</div>
  </div>
</section>

<hr>

<footer>
  Comet-AI Electron Desktop Integration Guide ‚Äî v2.0 ‚Äî February 2026<br>
  Electron 32+ ¬∑ CEF ¬∑ RobotJS ¬∑ Tesseract ¬∑ Flutter Bridge ¬∑ MCP v2<br>
  <span style="color:var(--accent-cyan)">// Security-first. Every action gated. Every action logged.</span>
</footer>

</div><!-- .container -->
</body>
</html>